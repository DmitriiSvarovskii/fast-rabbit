# Изменения в логике аутентификации Fast Rabbit VPN

## Обзор изменений

Проект был обновлен для работы с новой логикой аутентификации через Telegram WebApp API. Теперь при открытии web-app автоматически происходит аутентификация пользователя, и все последующие запросы используют полученный токен доступа.

## Основные изменения

### 1. API Module (`public/js/modules/apiModule.js`)

#### Новые функции:
- `authenticate()` - автоматическая аутентификация через Telegram WebApp
- Автоматическое добавление токена авторизации ко всем запросам
- Автоматическое обновление токена при получении 401 ошибки

#### Измененные функции:
- `getUser()` - теперь использует только данные из аутентификации, не делает запросы к API
- `getBalance()` - теперь использует только данные из аутентификации, не делает запросы к API
- `createPayment()` - убран параметр user_id
- `getPaymentHistory()` - убран параметр user_id
- `deleteKey()` - обновлен URL для соответствия API
- Все методы теперь используют Bearer токен авторизации

### 2. Главный файл приложения (`public/js/app.js`)

#### Изменения:
- Добавлено ожидание завершения аутентификации перед инициализацией остальных модулей
- Убрано отдельное обновление баланса, так как он загружается вместе с данными пользователя
- Улучшена последовательность инициализации модулей

### 3. Payment Module (`public/js/modules/paymentModule.js`)

#### Изменения:
- `loadPaymentHistory()` - убран параметр telegram_id
- Все методы теперь работают с токеном авторизации

## Новая логика работы

### 1. Аутентификация
При открытии web-app:
1. Инициализируется Telegram модуль
2. API модуль автоматически:
   - Получает данные инициализации из Telegram WebApp
   - Отправляет POST запрос на `/auth/telegram` с заголовком `X-Telegram-WebApp-InitData`
   - Получает токен доступа и данные пользователя
   - Сохраняет токен для последующих запросов

### 2. Запросы к API
Все запросы к API теперь:
- Автоматически включают заголовок `Authorization: Bearer <token>`
- При получении 401 ошибки автоматически переаутентифицируются
- Не требуют передачи telegram_id в параметрах

### 3. Использование данных пользователя
- Все данные пользователя (баланс, ключи, информация) загружаются один раз при аутентификации
- Методы `getUser()` и `getBalance()` используют кэшированные данные
- Дополнительные запросы к API не выполняются для получения базовой информации

### 4. Структура ответа аутентификации
```json
{
  "id": 1,
  "telegram_id": 606825877,
  "first_name": "Дмитрий",
  "last_name": "Сваровский",
  "username": "swarovskidima",
  "balance": {
    "balance": 600
  },
  "keys": [
    {
      "id": 2,
      "country": "Germany",
      "key": "vless://...",
      "created_at": "2025-08-29T17:51:32.793302"
    }
  ],
  "access_token": {
    "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
    "token_type": "bearer",
    "expires_in": 3600
  }
}
```

## Устраненные проблемы

### 1. Старые запросы
- Убраны запросы к `/user/{telegram_id}` - теперь используется только аутентификация
- Убраны запросы к `/balance/me` с `X-Telegram-Init-Data` - баланс берется из данных аутентификации
- Все данные загружаются одним запросом при аутентификации

### 2. Оптимизация
- Убрано дублирование запросов для получения баланса
- Данные пользователя кэшируются в `window.currentUser`
- Улучшена производительность за счет уменьшения количества запросов

## Тестирование

Для тестирования новой логики создан файл `test-new-auth.html`, который:
- Инициализирует модули
- Выполняет аутентификацию
- Отображает полученные данные пользователя
- Показывает баланс и ключи
- Тестирует методы API без дополнительных запросов

## Совместимость

Все изменения обратно совместимы с существующим кодом:
- Глобальные функции (`copyKey`, `toggleSubsection`, `openTelegramSupport`) остались без изменений
- UI модуль работает без изменений
- Серверная часть не требует изменений

## Безопасность

- Токен доступа автоматически обновляется при истечении
- Все запросы к API защищены Bearer токеном
- Данные пользователя кэшируются в `window.currentUser`
- Обработка ошибок аутентификации с уведомлениями пользователя
